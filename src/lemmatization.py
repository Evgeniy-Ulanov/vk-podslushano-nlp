# lemmatization.py
# Препроцессинг и лемматизация текста для проекта «Подслушано».
# Евгений Уланов

import re
import pandas as pd
import nltk
from nltk.corpus import stopwords
from pymystem3 import Mystem


# ----------------------------------------------------------
# Инициализация
# ----------------------------------------------------------

# Русские стоп-слова
nltk.download("stopwords")
stop = stopwords.words("russian")

# Добавляем пользовательские стоп-слова (как в ноутбуке)
stop.extend([
    'я','а','да','но','тебе','мне','ты','и','у','на','ща','ага','так','там','какие','который',
    'какая','туда','давай','короче','кажется','вообще','ну','не','чет','неа','свои','наше','наш',
    'весь','хотя','такое','например','кароч','как-то','нам','хм','всем','нет','да','оно','своем',
    'про','вы','м','тд','класс','пожалуйста','пост','свой','почему','вся','кто-то','что-то','вам',
    'это','эта','эти','этот','прям','либо','как','мы','просто','блин','очень','самые','твоем',
    'ваша','кстати','вроде','типа','пока','ок','анон','анонимно','админ','ребята','ай','мочь',
    'школа','ваш','привет','б','а','год','группа','день','adm','спасибо','новый','хотеть','сегодня',
    'участник','большой','https','урок','лицей','самый','делать','писать','написать','учитель',
    'второй','знапт','малышев','дата','левченко','антон','находить','желать','стать','хороший',
    'человек','школе','школу','школы','любить','девочка','сказать','давать','учиться','ходить',
    'искать','сделать','думать','видеть','понимать','говорить','помогать','уходить','приходить',
    'рассказывать','оставаться','начинать','ждать','оставлять','спрашивать','искать'
])

# Лемматизатор
lem = Mystem()


# ----------------------------------------------------------
# Очистка текста
# ----------------------------------------------------------

def clean_text(text):
    """
    Простая очистка строки:
    - приведение к нижнему регистру
    - удаление пунктуации
    - удаление лишних пробелов
    """
    if not isinstance(text, str):
        return ""

    text = text.lower()
    text = re.sub(r"\s+", " ", text)
    text = re.sub(r"[^\w\s]", "", text)
    return text.strip()


# ----------------------------------------------------------
# Удаление стоп-слов
# ----------------------------------------------------------

def remove_stop_words(text):
    words = text.split()
    filtered = [w for w in words if w not in stop]
    return " ".join(filtered)


# ----------------------------------------------------------
# Лемматизация одного текста
# ----------------------------------------------------------

def preprocess_text(text):
    """
    Лемматизация текста при помощи Mystem.
    Возвращает список лемм.
    """
    lemmatized = lem.lemmatize(text)
    clean_lemmas = [
        word.rstrip()
        for word in ''.join(lemmatized).split(' ')
        if word not in stop and word != ''
    ]
    return clean_lemmas


# ----------------------------------------------------------
# Обработка всего DataFrame
# ----------------------------------------------------------

def preprocess_dataframe(df: pd.DataFrame,
                         input_column: str = "text",
                         cleaned_column: str = "lines_processed",
                         output_column: str = "lines_lemmatized") -> pd.DataFrame:
    """
    Выполняет полный цикл:
    1. очистка текста
    2. удаление стоп-слов
    3. лемматизация
    """

    df = df.copy()

    # 1. базовая очистка текста
    df[cleaned_column] = df[input_column].astype(str).apply(clean_text)

    # 2. удаление стоп-слов
    df[cleaned_column] = df[cleaned_column].apply(remove_stop_words)

    # 3. лемматизация
    df[output_column] = df[cleaned_column].apply(preprocess_text)

    return df
